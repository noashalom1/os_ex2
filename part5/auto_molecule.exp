#!/usr/bin/expect -f
set timeout 1

# Parse flags: -h <host> -p <port> OR -f <socket_path>
set host ""
set port ""
set uds_path ""

for {set i 0} {$i < $argc} {incr i} {
    set arg [lindex $argv $i]
    if {$arg == "-h"} {
        incr i
        set host [lindex $argv $i]
    } elseif {$arg == "-p"} {
        incr i
        set port [lindex $argv $i]
    } elseif {$arg == "-f"} {
        incr i
        set uds_path [lindex $argv $i]
    }
}

# Validation
if {$uds_path eq "" && ($host eq "" || $port eq "")} {
    puts "Usage: ./auto_molecule.exp [-h <host> -p <port>] | [-f <socket_path>]"
    exit 1
}

# Launch client accordingly
if {$uds_path ne ""} {
    spawn ./molecule_requester -f $uds_path
} else {
    spawn ./molecule_requester -h $host -p $port
}

# Wait for confirmation
expect {
    "Connected to molecule server" {}
    timeout { puts "❌ Failed to connect to molecule server"; exit 1 }
}

# Open command file
set f [open "commands_molecular.txt"]
while {[gets $f line] >= 0} {
    send -- "$line\r"
    expect {
        -re "Server response:.*\n" {}
        timeout {}
    }
    sleep 0.1
}
close $f

# Graceful shutdown
sleep 1
send -- "\004"  ;# Send EOF (Ctrl+D)
expect eof
